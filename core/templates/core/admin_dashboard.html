{% extends 'core/base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- 👇 Title + Bell + Dark Mode -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>📊 Admin Dashboard</h2>

        <div class="d-flex align-items-center gap-3">
            <!-- ✅ Notification Bell -->
            <div id="bellBox" class="notification-bell">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor"
                    class="bi bi-bell" viewBox="0 0 16 16">
                    <path
                        d="M8 16a2 2 0 0 0 1.985-1.75H6.015A2 2 0 0 0 8 16zm.104-14.708C8.58.755 9 1.27 9 2v.098a5 5 0 0 1 3.286 4.714v.5l.816 2.45A1 1 0 0 1 12.138 11H3.862a1 1 0 0 1-.964-1.446L3.714 7.312v-.5A5 5 0 0 1 7 2.098V2c0-.73.42-1.245.896-1.708A1 1 0 0 1 8.104 1.292z" />
                </svg>
                <span id="notifCount" class="notification-count" style="display:none;">0</span>
                <div id="notifDropdown" class="notifications-dropdown"></div>
            </div>

            <!-- 🌙 Dark Mode Button -->
            <button id="darkModeBtn" class="btn btn-outline-secondary btn-sm" title="Toggle Dark Mode">🌙</button>
        </div>
    </div>

    <!-- ✅ Bell Styles -->
    <style>
        .notification-bell {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 16px;
        }

        .notification-count {
            position: absolute;
            top: -6px;
            right: -8px;
            background: #dc3545;
            color: #fff;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .notifications-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 28px;
            width: 320px;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
            z-index: 9999;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 6px;
        }

        .note {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f1f1;
            font-size: 14px;
        }

        .note.unread {
            background: #f8f9fa;
            font-weight: 600;
        }

        .dropdown-footer {
            text-align: center;
            padding: 6px;
            border-top: 1px solid #eee;
        }

        /* 🌙 Dark Mode Styling */
        body.dark-mode {
            background-color: #121212;
            color: #e6e6e6;
        }

        body.dark-mode .card {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e6e6e6;
        }

        body.dark-mode .table {
            color: #ddd;
        }

        body.dark-mode .table-dark {
            background-color: #2b2b2b;
        }

        body.dark-mode .notifications-dropdown {
            background: #2a2a2a;
            color: #e6e6e6;
        }

        body.dark-mode .note {
            border-bottom: 1px solid #444;
        }

        body.dark-mode .dropdown-footer {
            border-top: 1px solid #444;
        }

        body.dark-mode .btn-outline-secondary {
            border-color: #888;
            color: #ccc;
        }

        body.dark-mode .btn-outline-secondary:hover {
            background: #333;
            color: #fff;
        }
    </style>

    <!-- ✅ Dashboard Summary -->
    <div class="row text-center mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white shadow-sm rounded-4">
                <div class="card-body">
                    <h5>Total Users</h5>
                    <h3>{{ total_users }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white shadow-sm rounded-4">
                <div class="card-body">
                    <h5>Total Jobs</h5>
                    <h3>{{ total_jobs }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-white shadow-sm rounded-4">
                <div class="card-body">
                    <h5>Total Applications</h5>
                    <h3>{{ total_applications }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Chart -->
    <div class="card mb-4 shadow-sm rounded-4">
        <div class="card-body text-center">
            <h5 class="mb-3">📈 Applications by Status</h5>
            <div style="max-width: 300px; margin: 0 auto;">
                <canvas id="appStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ✅ Table -->
    <div class="card shadow-sm rounded-4">
        <div class="card-body">
            <h5 class="mb-3">🕒 Recent Applications</h5>
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Job</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for app in applications %}
                    <tr>
                        <td>{{ app.user.username }}</td>
                        <td>{{ app.user.email }}</td>
                        <td>{{ app.job.title }}</td>
                        <td>
                            {% if app.status == "accepted" %}
                            <span class="badge bg-success">Accepted</span>
                            {% elif app.status == "declined" %}
                            <span class="badge bg-danger">Declined</span>
                            {% else %}
                            <span class="badge bg-secondary">Pending</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'update_application_status' app.id 'accepted' %}"
                                class="btn btn-sm btn-outline-success"
                                onclick="addNotification('Application by {{ app.user.username }} for {{ app.job.title }} accepted!')">Accept</a>
                            <a href="{% url 'update_application_status' app.id 'declined' %}"
                                class="btn btn-sm btn-outline-danger"
                                onclick="addNotification('Application by {{ app.user.username }} for {{ app.job.title }} declined!')">Decline</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">No applications yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ✅ Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Notification Logic (unchanged) -->
<script>
(function(){
  const bellBox = document.getElementById('bellBox');
  const notifCount = document.getElementById('notifCount');
  const notifDropdown = document.getElementById('notifDropdown');

  function getNotifications(){
    return JSON.parse(localStorage.getItem('admin_notifications') || '[]');
  }
  function saveNotifications(list){
    localStorage.setItem('admin_notifications', JSON.stringify(list));
  }
  window.addNotification = function(message){
    const notes = getNotifications();
    notes.unshift({
      message: message,
      created_at: new Date().toLocaleString(),
      is_read: false
    });
    saveNotifications(notes);
    renderNotifications();
  }
  function renderNotifications(){
    const notes = getNotifications();
    notifDropdown.innerHTML = '';
    if (notes.length === 0){
      notifDropdown.innerHTML = '<div class="note">No notifications yet.</div>';
      notifCount.style.display = 'none';
      return;
    }
    let unreadCount = notes.filter(n => !n.is_read).length;
    notifCount.style.display = unreadCount > 0 ? 'inline-block' : 'none';
    notifCount.textContent = unreadCount;

    notes.forEach((n, i)=>{
      const div = document.createElement('div');
      div.className = 'note ' + (n.is_read ? '' : 'unread');
      div.innerHTML = `<div>${n.message}</div><small>${n.created_at}</small>`;
      div.onclick = function(){
        n.is_read = true;
        saveNotifications(notes);
        renderNotifications();
      };
      notifDropdown.appendChild(div);
    });
    const footer = document.createElement('div');
    footer.className = 'dropdown-footer';
    footer.innerHTML = '<button id="markAllRead" class="btn btn-sm btn-secondary">Mark all as read</button>';
    notifDropdown.appendChild(footer);
    document.getElementById('markAllRead').onclick = function(){
      notes.forEach(n => n.is_read = true);
      saveNotifications(notes);
      renderNotifications();
    };
  }
  bellBox.addEventListener('click', function(){
    notifDropdown.style.display = notifDropdown.style.display === 'block' ? 'none' : 'block';
  });
  document.addEventListener('click', function(e){
    if (!bellBox.contains(e.target)){
      notifDropdown.style.display = 'none';
    }
  });
  renderNotifications();
})();
</script>

<!-- 🌙 Dark Mode Script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const darkModeBtn = document.getElementById('darkModeBtn');
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme === 'dark') {
    document.body.classList.add('dark-mode');
    darkModeBtn.textContent = '☀️';
  }

  darkModeBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    darkModeBtn.textContent = isDark ? '☀️' : '🌙';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });
});
</script>

<!-- Chart Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById("appStatusChart");
    if (!ctx) return;

    const labels = [{% for item in app_status_counts %}"{{ item.status|title }}",{% endfor %}];
    const values = [{% for item in app_status_counts %}{{ item.count }},{% endfor %}];
    const total = values.reduce((a, b) => a + b, 0);

    new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: labels,
            datasets: [{
                label: "Applications",
                data: values,
                backgroundColor: ["#36A2EB", "#4BC0C0", "#FFCE56", "#FF6384", "#9966FF"],
                borderColor: "#fff",
                borderWidth: 2,
                cutout: "70%"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: {
                legend: {
                    position: "bottom",
                    labels: { boxWidth: 15, font: { size: 13 } }
                },
                title: {
                    display: true,
                    text: "Application Status Distribution",
                    font: { size: 16 }
                },
                datalabels: {
                    color: "#fff",
                    font: { weight: "bold" },
                    formatter: (value) => total === 0 ? "0%" : ((value / total) * 100).toFixed(1) + "%"
                }
            }
        },
        plugins: [ChartDataLabels],
    });
});
</script>
{% endblock %}
